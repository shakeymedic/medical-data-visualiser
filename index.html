<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Risk Communication Tool - WMEBEM</title>
    <meta name="description" content="Evidence-based medical risk communication tool for healthcare professionals to visualise diagnostic test performance, risk reduction, and biomarker context.">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .print-hidden { display: none !important; }
            .print-bg-white { background-color: white !important; }
            .print-text-gray { color: #111827 !important; }
        }
    </style>
  <style>
    .population-grid {
      display: grid;
    }
    @media (max-width: 640px) {
      .population-grid { grid-template-columns: repeat(20, minmax(0, 1fr)) !important; }
    }
    @media (min-width: 641px) {
      .population-grid { grid-template-columns: repeat(40, minmax(0, 1fr)) !important; }
    }
  </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <div class="bg-blue-900 text-white py-6 px-4 print-bg-white print-text-gray">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Medical Risk Communication Tool</h1>
                    <p class="text-blue-100 print-text-gray">Evidence-based visualisation for patient communication</p>
                </div>
                <img src="https://i.imgur.com/09eFLTO.png" alt="WMEBEM Logo" class="h-16 md:h-20">
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 py-6">
            <div id="tabs" class="flex gap-2 mb-6 overflow-x-auto print-hidden">
                <button onclick="switchTab('diagnostic')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="diagnostic">
                    Diagnostic Test
                </button>
                <button onclick="switchTab('risk')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="risk">
                    Risk Visualiser
                </button>
                <button onclick="switchTab('reduction')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="reduction">
                    Risk Reduction
                </button>
                <button onclick="switchTab('nnt')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="nnt">
                    NNT/NNH
                </button>
                <button onclick="switchTab('relative')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="relative">
                    Relative vs Absolute
                </button>
                <button onclick="switchTab('biomarker')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="biomarker">
                    Biomarker Context
                </button>
                <button onclick="switchTab('likelihood')" class="tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors" data-tab="likelihood">
                    Bayes Calculator
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-end gap-2 mb-4 print-hidden">
                    <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        Print
                    </button>
                </div>

                <div id="tab-content"></div>
            </div>

            <div class="mt-8 bg-white rounded-lg shadow-md p-6 print-hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Evidence-Based Communication Tips</h3>
                <ul class="space-y-2 text-gray-700 text-sm">
                    <li class="flex items-start">
                        <span class="text-blue-900 mr-2">•</span>
                        <span>Use numbers (even approximate) rather than verbal terms like "rare" or "common"</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-900 mr-2">•</span>
                        <span>Use consistent denominators (e.g., per 100 or per 1000) instead of varying "1 in X" formats</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-900 mr-2">•</span>
                        <span>Present absolute risk differences, not relative reductions, to avoid overestimating benefits</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-900 mr-2">•</span>
                        <span>Show both numerator and denominator in visual displays (icon arrays or stacked bars)</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-900 mr-2">•</span>
                        <span>Provide context for biomarkers: normal ranges, targets, and action thresholds</span>
                    </li>
                </ul>
                <p class="text-xs text-gray-500 mt-4">Based on: Zikmund-Fisher BJ, Thorpe A, Fagerlin A. How to Communicate Medical Numbers. JAMA. 2025.</p>
            </div>
        </div>
    </div>

    <script>
        var state = {
            activeTab: 'diagnostic',
            diagnostic: {
                sensitivity: 95,
                specificity: 90,
                prevalence: 10,
                population: 1000
            },
            risk: {
                risk: 5,
                population: 100
            },
            reduction: {
                baselineRisk: 10,
                treatmentRisk: 6,
                population: 100
            },
            nnt: {
                baselineRisk: 10,
                treatmentRisk: 6
            },
            relative: {
                baselineRisk: 10,
                relativeReduction: 50
            },
            biomarker: {
                value: 8.3,
                unit: '%',
                normalMin: 4.0,
                normalMax: 5.6,
                targetValue: 7.0,
                thresholdValue: '',
                biomarkerName: 'HbA1c'
            },
            likelihood: {
                preTestProb: 20,
                likelihoodRatio: 5
            }
        };

        function createIconArray(affected, total, colour, label) {
            var displayTotal = Math.min(total, 1000);
            var html = '<div class="grid population-grid gap-1 max-w-2xl">';
            var affectedCount = (total > 0) ? Math.round((affected / total) * displayTotal) : 0;

            for (var i = 0; i < displayTotal; i++) {
                var isAffected = i < affectedCount;
                var bgColour = isAffected ? colour : 'bg-gray-200';
                var title = isAffected ? label : 'Not affected';
                html += '<div class="w-3 h-3 rounded-sm ' + bgColour + '" title="' + title + '"></div>';
            }
            
            html += '</div>';
            if (total > 1000) {
                html += '<p class="text-xs text-gray-500 mt-2">Visualising ' + displayTotal + ' of ' + total + ' people.</p>';
            }
            return html;
        }

        function createStackedBar(affected, total, colour, label) {
            var percentage = (affected / total) * 100;
            var html = '<div class="w-full max-w-xl">';
            html += '<div class="h-12 bg-gray-200 rounded-lg overflow-hidden flex">';
            html += '<div class="' + colour + ' flex items-center justify-center text-white font-semibold text-sm" style="width: ' + percentage + '%">';
            html += (percentage > 10 ? affected : '');
            html += '</div>';
            html += '<div class="flex-1 flex items-center justify-center text-gray-600 text-sm">';
            if (percentage <= 10) {
                html += '<span class="text-gray-700 font-semibold mr-2">' + affected + '</span>';
            }
            html += (total - affected);
            html += '</div>';
            html += '</div>';
            html += '<div class="flex justify-between text-xs text-gray-600 mt-1">';
            html += '<span>' + label + '</span>';
            html += '<span>Not affected</span>';
            html += '</div>';
            html += '</div>';
            return html;
        }

        function calculateDiagnostic() {
            var sens = state.diagnostic.sensitivity;
            var spec = state.diagnostic.specificity;
            var prev = state.diagnostic.prevalence;
            var pop = state.diagnostic.population;
            
            var diseased = (prev / 100) * pop;
            var healthy = pop - diseased;
            var truePositive = (sens / 100) * diseased;
            var falseNegative = diseased - truePositive;
            var trueNegative = (spec / 100) * healthy;
            var falsePositive = healthy - trueNegative;
            
            return {
                truePositive: Math.round(truePositive),
                falseNegative: Math.round(falseNegative),
                trueNegative: Math.round(trueNegative),
                falsePositive: Math.round(falsePositive),
                diseased: Math.round(diseased),
                healthy: Math.round(healthy)
            };
        }

        function calculateNNT() {
            var base = state.nnt.baselineRisk;
            var treat = state.nnt.treatmentRisk;
            var arr = base - treat;
            if (arr <= 0) return null;
            return Math.round(100 / arr);
        }

        function calculateRelativeRisk() {
            var base = state.relative.baselineRisk;
            var rel = state.relative.relativeReduction;
            var absRed = (base * rel) / 100;
            var newRisk = base - absRed;
            return {
                absoluteReduction: absRed.toFixed(1),
                newRisk: newRisk.toFixed(1)
            };
        }
        
        function calculateLikelihood() {
            var preProb = state.likelihood.preTestProb;
            var lr = state.likelihood.likelihoodRatio;

            if (preProb <= 0 || preProb >= 100 || lr <= 0) {
                return { postTestProb: null };
            }

            var preOdds = preProb / (100 - preProb);
            var postOdds = preOdds * lr;
            var postProb = (postOdds / (1 + postOdds)) * 100;

            return {
                postTestProb: postProb
            };
        }
        
        function createFaganNomogram(preTestProb, lr, postTestProb) {
            var svgWidth = 600;
            var svgHeight = 400;
            var padding = { top: 50, right: 60, bottom: 40, left: 60 };
            var axisX = { pre: padding.left + 40, lr: svgWidth / 2, post: svgWidth - padding.right - 40 };
            var plotHeight = svgHeight - padding.top - padding.bottom;

            var probTicks = [0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 30, 50, 70, 80, 90, 95, 98, 99];
            var lrTicks = [1000, 200, 100, 50, 20, 10, 5, 2, 1, 0.5, 0.2, 0.1, 0.05, 0.02, 0.01];

            // Map log-odds to Y coordinate
            var minLogOdds = Math.log(0.001 / 0.999); // Approx 0.1%
            var maxLogOdds = Math.log(0.999 / 0.001); // Approx 99.9%
            function probToY(p) {
                if (p <= 0 || p >= 100) return padding.top + plotHeight;
                var odds = p / (100 - p);
                var logOdds = Math.log(odds);
                return padding.top + plotHeight * (1 - (logOdds - minLogOdds) / (maxLogOdds - minLogOdds));
            }

            // Map log(LR) to Y coordinate
            var minLogLR = Math.log(0.01);
            var maxLogLR = Math.log(1000);
            function lrToY(val) {
                var logVal = Math.log(val);
                return padding.top + plotHeight * (1 - (logVal - minLogLR) / (maxLogLR - minLogLR));
            }
            
            var html = '<svg width="100%" viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '" class="mx-auto">';
            html += '<text x="' + axisX.pre + '" y="' + (padding.top - 15) + '" font-size="12" text-anchor="middle" font-weight="bold">Pre-Test Probability (%)</text>';
            html += '<text x="' + axisX.lr + '" y="' + (padding.top - 15) + '" font-size="12" text-anchor="middle" font-weight="bold">Likelihood Ratio</text>';
            html += '<text x="' + axisX.post + '" y="' + (padding.top - 15) + '" font-size="12" text-anchor="middle" font-weight="bold">Post-Test Probability (%)</text>';

            // Draw axes
            html += '<line x1="' + axisX.pre + '" y1="' + padding.top + '" x2="' + axisX.pre + '" y2="' + (svgHeight - padding.bottom) + '" stroke="#9ca3af" />';
            html += '<line x1="' + axisX.lr + '" y1="' + padding.top + '" x2="' + axisX.lr + '" y2="' + (svgHeight - padding.bottom) + '" stroke="#9ca3af" />';
            html += '<line x1="' + axisX.post + '" y1="' + padding.top + '" x2="' + axisX.post + '" y2="' + (svgHeight - padding.bottom) + '" stroke="#9ca3af" />';

            // Draw ticks
            probTicks.forEach(function(p) {
                var y = probToY(p);
                html += '<line x1="' + (axisX.pre - 5) + '" y1="' + y + '" x2="' + axisX.pre + '" y2="' + y + '" stroke="#4b5563" />';
                html += '<text x="' + (axisX.pre - 8) + '" y="' + (y + 4) + '" font-size="10" text-anchor="end">' + p + '</text>';
                html += '<line x1="' + axisX.post + '" y1="' + y + '" x2="' + (axisX.post + 5) + '" y2="' + y + '" stroke="#4b5563" />';
                html += '<text x="' + (axisX.post + 8) + '" y="' + (y + 4) + '" font-size="10" text-anchor="start">' + p + '</text>';
            });

            lrTicks.forEach(function(val) {
                var y = lrToY(val);
                html += '<line x1="' + (axisX.lr - 5) + '" y1="' + y + '" x2="' + (axisX.lr + 5) + '" y2="' + y + '" stroke="#4b5563" />';
                html += '<text x="' + (axisX.lr + 8) + '" y="' + (y + 4) + '" font-size="10">' + val + '</text>';
            });
            
            // Draw connecting line and markers
            if (postTestProb !== null) {
                var yPre = probToY(preTestProb);
                var yPost = probToY(postTestProb);
                html += '<line x1="' + axisX.pre + '" y1="' + yPre + '" x2="' + axisX.post + '" y2="' + yPost + '" stroke="#ef4444" stroke-width="2" />';
                html += '<circle cx="' + axisX.pre + '" cy="' + yPre + '" r="4" fill="#ef4444" />';
                html += '<circle cx="' + axisX.post + '" cy="' + yPost + '" r="4" fill="#ef4444" />';
                
                // Calculate intersection with LR axis
                var yLr = yPre + (yPost - yPre) * (axisX.lr - axisX.pre) / (axisX.post - axisX.pre);
                html += '<circle cx="' + axisX.lr + '" cy="' + yLr + '" r="4" fill="#ef4444" />';
            }
            html += '</svg>';
            return html;
        }

        function renderDiagnostic() {
            var results = calculateDiagnostic();
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Diagnostic Test Performance</h2>';
            html += '<p class="text-gray-600 mb-6">This shows how a test performs for a whole population, including correct results and errors.</p>';

            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Sensitivity (%)</label>';
            html += '<input type="number" value="' + state.diagnostic.sensitivity + '" onchange="updateState(\'diagnostic\', \'sensitivity\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Specificity (%)</label>';
            html += '<input type="number" value="' + state.diagnostic.specificity + '" onchange="updateState(\'diagnostic\', \'specificity\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Disease Prevalence (%)</label>';
            html += '<input type="number" value="' + state.diagnostic.prevalence + '" onchange="updateState(\'diagnostic\', \'prevalence\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Population Size</label>';
            html += '<input type="number" value="' + state.diagnostic.population + '" onchange="updateState(\'diagnostic\', \'population\', parseInt(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="100" max="10000" step="100"></div>';
            html += '</div>';
            
            html += '<div class="space-y-4">';
            var population = state.diagnostic.population;
            if (population > 0) {
                html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Combined Test Results for ' + population + ' People</h3>';

                var displayTotal = Math.min(population, 1000);
                var displayedTP = Math.round((results.truePositive / population) * displayTotal);
                var displayedFN = Math.round((results.falseNegative / population) * displayTotal);
                var displayedFP = Math.round((results.falsePositive / population) * displayTotal);
                var displayedTN = displayTotal - displayedTP - displayedFN - displayedFP;

                var iconsHtml = '<div class="grid population-grid gap-1 max-w-2xl">';
                for (var i = 0; i < displayTotal; i++) {
                    if (i < displayedTP) {
                        iconsHtml += '<div class="w-3 h-3 rounded-sm bg-green-500" title="True Positive"></div>';
                    } else if (i < displayedTP + displayedFN) {
                        iconsHtml += '<div class="w-3 h-3 rounded-sm bg-red-500" title="False Negative"></div>';
                    } else if (i < displayedTP + displayedFN + displayedFP) {
                        iconsHtml += '<div class="w-3 h-3 rounded-sm bg-orange-500" title="False Positive"></div>';
                    } else {
                        iconsHtml += '<div class="w-3 h-3 rounded-sm bg-sky-400" title="True Negative"></div>';
                    }
                }
                iconsHtml += '</div>';
                if (population > 1000) {
                    iconsHtml += '<p class="text-xs text-gray-500 mt-2">Visualising a sample of ' + displayTotal + ' of ' + population + ' people.</p>';
                }
                html += iconsHtml;
                html += '</div>';

                html += '<div>';
                html += '<h3 class="text-lg font-semibold text-gray-900 mb-3 mt-6">Understanding the Results</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">';
                
                html += '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200"><div class="flex items-start">';
                html += '<span class="flex-shrink-0 inline-block w-4 h-4 rounded-sm bg-green-500 mr-3 mt-1"></span>';
                html += '<div><p class="font-bold text-gray-800">True Positives: ' + results.truePositive + '</p>';
                html += '<p class="text-gray-600">People who have the condition and the test correctly found it.</p>';
                html += '</div></div></div>';
                
                html += '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200"><div class="flex items-start">';
                html += '<span class="flex-shrink-0 inline-block w-4 h-4 rounded-sm bg-red-500 mr-3 mt-1"></span>';
                html += '<div><p class="font-bold text-gray-800">False Negatives: ' + results.falseNegative + '</p>';
                html += '<p class="text-gray-600">People who have the condition, but the test unfortunately missed it.</p>';
                html += '</div></div></div>';
                
                html += '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200"><div class="flex items-start">';
                html += '<span class="flex-shrink-0 inline-block w-4 h-4 rounded-sm bg-orange-500 mr-3 mt-1"></span>';
                html += '<div><p class="font-bold text-gray-800">False Positives: ' + results.falsePositive + '</p>';
                html += '<p class="text-gray-600">People who are healthy, but the test incorrectly said they have the condition.</p>';
                html += '</div></div></div>';
                
                html += '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200"><div class="flex items-start">';
                html += '<span class="flex-shrink-0 inline-block w-4 h-4 rounded-sm bg-sky-400 mr-3 mt-1"></span>';
                html += '<div><p class="font-bold text-gray-800">True Negatives: ' + results.trueNegative + '</p>';
                html += '<p class="text-gray-600">People who are healthy, and the test correctly confirmed it.</p>';
                html += '</div></div></div>';

                html += '</div></div>';
            }
            html += '</div>';

            return html;
        }

        function renderRisk() {
            var affected = Math.round((state.risk.risk / 100) * state.risk.population);
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Absolute Risk Visualiser</h2>';
            html += '<p class="text-gray-600 mb-6">Show risk as people affected out of a population.</p>';
            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Risk (%)</label>';
            html += '<input type="number" value="' + state.risk.risk + '" onchange="updateState(\'risk\', \'risk\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Population Size</label>';
            html += '<select onchange="updateState(\'risk\', \'population\', parseInt(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg">';
            html += '<option value="100"' + (state.risk.population === 100 ? ' selected' : '') + '>100 people</option>';
            html += '<option value="1000"' + (state.risk.population === 1000 ? ' selected' : '') + '>1000 people</option>';
            html += '</select></div></div>';
            html += '<div class="space-y-8">';
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Icon Array: ' + affected + ' out of ' + state.risk.population + ' affected</h3>';
            html += createIconArray(affected, state.risk.population, 'bg-red-500', 'Affected');
            html += '</div>';
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Stacked Bar</h3>';
            html += createStackedBar(affected, state.risk.population, 'bg-red-500', 'Affected');
            html += '</div>';
            html += '<div class="bg-blue-50 border-l-4 border-blue-500 p-4">';
            html += '<p class="text-blue-800"><strong>' + state.risk.risk + '%</strong> means approximately <strong>' + affected + ' out of every ' + state.risk.population + ' people</strong> will be affected.</p></div>';
            html += '</div>';
            return html;
        }

        function renderReduction() {
            var before = Math.round((state.reduction.baselineRisk / 100) * state.reduction.population);
            var after = Math.round((state.reduction.treatmentRisk / 100) * state.reduction.population);
            var diff = before - after;
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Risk Reduction Calculator</h2>';
            html += '<p class="text-gray-600 mb-6">Compare absolute risks before and after treatment.</p>';
            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Baseline Risk (%)</label>';
            html += '<input type="number" value="' + state.reduction.baselineRisk + '" onchange="updateState(\'reduction\', \'baselineRisk\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Risk After Treatment (%)</label>';
            html += '<input type="number" value="' + state.reduction.treatmentRisk + '" onchange="updateState(\'reduction\', \'treatmentRisk\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="0.1"></div></div>';
            html += '<div class="space-y-8">';
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Before Treatment</h3>';
            html += createIconArray(before, state.reduction.population, 'bg-red-500', 'At risk');
            html += '<p class="text-sm text-gray-600 mt-2">' + before + ' out of ' + state.reduction.population + ' affected</p></div>';
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">After Treatment</h3>';
            html += createIconArray(after, state.reduction.population, 'bg-orange-500', 'Still at risk');
            html += '<p class="text-sm text-gray-600 mt-2">' + after + ' out of ' + state.reduction.population + ' affected</p></div>';
            html += '<div class="bg-green-50 border-l-4 border-green-500 p-4"><h4 class="font-semibold text-green-900 mb-2">Absolute Risk Reduction</h4>';
            html += '<p class="text-green-800 text-lg">Treatment reduces risk from <strong>' + state.reduction.baselineRisk + '%</strong> to <strong>' + state.reduction.treatmentRisk + '%</strong></p>';
            html += '<p class="text-green-800 mt-2">That is a <strong>' + (state.reduction.baselineRisk - state.reduction.treatmentRisk).toFixed(1) + ' percentage point</strong> reduction</p>';
            html += '<p class="text-green-800 mt-2"><strong>' + diff + ' fewer people</strong> out of ' + state.reduction.population + ' will be affected</p></div>';
            html += '</div>';
            return html;
        }

        function renderNNT() {
            var nnt = calculateNNT();
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Number Needed to Treat (NNT)</h2>';
            html += '<p class="text-gray-600 mb-6">Calculate how many patients need treatment for one to benefit.</p>';
            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Baseline Risk (%)</label>';
            html += '<input type="number" value="' + state.nnt.baselineRisk + '" onchange="updateState(\'nnt\', \'baselineRisk\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Risk After Treatment (%)</label>';
            html += '<input type="number" value="' + state.nnt.treatmentRisk + '" onchange="updateState(\'nnt\', \'treatmentRisk\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="0.1"></div></div>';
            
            if (!nnt) {
                html += '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">';
                html += '<p class="text-yellow-800">Treatment risk must be lower than baseline risk to calculate NNT.</p></div>';
            } else {
                html += '<div class="space-y-6">';
                html += '<div class="bg-blue-900 text-white p-8 rounded-lg text-center">';
                html += '<p class="text-lg mb-2">Number Needed to Treat</p>';
                html += '<p class="text-6xl font-bold">' + nnt + '</p></div>';
                html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Visual representation: Treat ' + nnt + ' patients for 1 to benefit</h3>';
                html += createIconArray(1, nnt, 'bg-green-500', 'Benefits from treatment');
                html += '</div>';
                html += '<div class="bg-blue-50 border-l-4 border-blue-500 p-4">';
                html += '<p class="text-blue-800">You need to treat <strong>' + nnt + ' patients</strong> for <strong>one patient to benefit</strong> from the treatment. ';
                html += 'The absolute risk reduction is <strong>' + (state.nnt.baselineRisk - state.nnt.treatmentRisk).toFixed(1) + ' percentage points</strong>.</p></div>';
                html += '</div>';
            }
            return html;
        }

        function renderRelative() {
            var results = calculateRelativeRisk();
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Relative vs Absolute Risk</h2>';
            html += '<p class="text-gray-600 mb-6">Convert relative risk reduction to absolute terms.</p>';
            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Baseline Risk (%)</label>';
            html += '<input type="number" value="' + state.relative.baselineRisk + '" onchange="updateState(\'relative\', \'baselineRisk\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Relative Risk Reduction (%)</label>';
            html += '<input type="number" value="' + state.relative.relativeReduction + '" onchange="updateState(\'relative\', \'relativeReduction\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" max="100" step="1"></div></div>';
            html += '<div class="space-y-8">';
            html += '<div class="grid md:grid-cols-2 gap-6">';
            html += '<div class="bg-red-50 border-2 border-red-200 p-6 rounded-lg">';
            html += '<h3 class="text-xl font-semibold text-red-900 mb-2">Misleading</h3>';
            html += '<p class="text-3xl font-bold text-red-700 mb-2">' + state.relative.relativeReduction + '%</p>';
            html += '<p class="text-red-800">Relative Risk Reduction</p>';
            html += '<p class="text-sm text-red-600 mt-4">This sounds impressive but does not tell patients the actual impact</p></div>';
            html += '<div class="bg-green-50 border-2 border-green-500 p-6 rounded-lg">';
            html += '<h3 class="text-xl font-semibold text-green-900 mb-2">Clear and Honest</h3>';
            html += '<p class="text-3xl font-bold text-green-700 mb-2">' + state.relative.baselineRisk + '% to ' + results.newRisk + '%</p>';
            html += '<p class="text-green-800">Absolute Risk Change</p>';
            html += '<p class="text-sm text-green-600 mt-4">' + results.absoluteReduction + ' percentage point reduction</p></div></div>';
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Visual Comparison</h3>';
            html += '<div class="space-y-4">';
            html += '<div><p class="text-sm font-medium text-gray-700 mb-2">Before Treatment</p>';
            html += createStackedBar(Math.round(state.relative.baselineRisk), 100, 'bg-red-500', 'At risk');
            html += '</div>';
            html += '<div><p class="text-sm font-medium text-gray-700 mb-2">After Treatment</p>';
            html += createStackedBar(Math.round(parseFloat(results.newRisk)), 100, 'bg-orange-500', 'At risk');
            html += '</div></div></div>';
            html += '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">';
            html += '<h4 class="font-semibold text-yellow-900 mb-2">Why This Matters</h4>';
            html += '<p class="text-yellow-800">A <strong>' + state.relative.relativeReduction + '% relative risk reduction</strong> sounds dramatic, but it actually means ';
            html += 'reducing your risk from <strong>' + state.relative.baselineRisk + '%</strong> to <strong>' + results.newRisk + '%</strong> - ';
            html += 'an absolute reduction of just <strong>' + results.absoluteReduction + ' percentage points</strong>.</p>';
            html += '<p class="text-yellow-800 mt-2">Out of 100 people, <strong>' + Math.round(results.absoluteReduction) + '</strong> fewer would experience the outcome.</p></div>';
            html += '</div>';
            return html;
        }

        function renderBiomarker() {
            var bio = state.biomarker;
            var minVal = bio.normalMin;
            var maxVal = bio.normalMax;
            var currentVal = bio.value;
            var targetVal = bio.targetValue;
            var thresholdVal = bio.thresholdValue;
            
            var allVals = [minVal, maxVal, currentVal];
            if (targetVal) allVals.push(targetVal);
            if (thresholdVal) allVals.push(parseFloat(thresholdVal));
            
            var min = Math.min.apply(null, allVals) * 0.8;
            var max = Math.max.apply(null, allVals) * 1.2;
            var range = max - min;
            
            function getPos(val) {
                if (!val || range === 0) return 0;
                return ((val - min) / range) * 100;
            }
            
            var normalPos = getPos(minVal);
            var normalWidth = getPos(maxVal) - normalPos;
            var valuePos = getPos(currentVal);
            var targetPos = targetVal ? getPos(targetVal) : null;
            var thresholdPos = thresholdVal ? getPos(parseFloat(thresholdVal)) : null;
            
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Biomarker Contextualiser</h2>';
            html += '<p class="text-gray-600 mb-6">Add context to lab results with normal ranges and targets.</p>';
            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Biomarker Name</label>';
            html += '<input type="text" value="' + bio.biomarkerName + '" onchange="updateState(\'biomarker\', \'biomarkerName\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>';
            html += '<input type="text" value="' + bio.unit + '" onchange="updateState(\'biomarker\', \'unit\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Patient Value</label>';
            html += '<input type="number" value="' + bio.value + '" onchange="updateState(\'biomarker\', \'value\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Normal Range Min</label>';
            html += '<input type="number" value="' + bio.normalMin + '" onchange="updateState(\'biomarker\', \'normalMin\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Normal Range Max</label>';
            html += '<input type="number" value="' + bio.normalMax + '" onchange="updateState(\'biomarker\', \'normalMax\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Target Value (optional)</label>';
            html += '<input type="number" value="' + (bio.targetValue || '') + '" onchange="updateState(\'biomarker\', \'targetValue\', parseFloat(this.value) || \'\')" class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.1" placeholder="Leave empty if none"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Action Threshold (optional)</label>';
            html += '<input type="number" value="' + bio.thresholdValue + '" onchange="updateState(\'biomarker\', \'thresholdValue\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.1" placeholder="Leave empty if none"></div>';
            html += '</div>';
            
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">' + bio.biomarkerName + ' Level</h3>';
            html += '<div class="w-full max-w-2xl mt-6">';
            html += '<div class="relative h-24 bg-gray-100 rounded-lg border-2 border-gray-300">';
            html += '<div class="absolute h-full bg-green-100 border-l-2 border-r-2 border-green-500" style="left: ' + normalPos + '%; width: ' + normalWidth + '%">';
            html += '<div class="absolute top-1 left-1/2 transform -translate-x-1/2 text-xs text-green-700 font-medium">Normal</div></div>';
            
            if (targetPos !== null) {
                html += '<div class="absolute h-full border-l-2 border-blue-500" style="left: ' + targetPos + '%">';
                html += '<div class="absolute -top-6 left-0 transform -translate-x-1/2 text-xs text-blue-600 font-medium whitespace-nowrap">Target: ' + bio.targetValue + bio.unit + '</div></div>';
            }
            
            if (thresholdPos !== null) {
                html += '<div class="absolute h-full border-l-2 border-orange-500" style="left: ' + thresholdPos + '%">';
                html += '<div class="absolute -bottom-6 left-0 transform -translate-x-1/2 text-xs text-orange-600 font-medium whitespace-nowrap">Threshold: ' + bio.thresholdValue + bio.unit + '</div></div>';
            }
            
            html += '<div class="absolute h-full" style="left: ' + valuePos + '%">';
            html += '<div class="absolute top-1/2 left-0 transform -translate-y-1/2 -translate-x-1/2 h-full border-l-4 border-red-600"></div>';
            html += '<div class="absolute top-1/2 left-0 transform -translate-y-1/2 -translate-x-1/2">';
            html += '<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white"></div></div>';
            html += '<div class="absolute top-1/2 left-0 transform -translate-y-1/2 translate-x-3 text-sm font-bold text-red-600 whitespace-nowrap bg-white/70 px-1 rounded">' + bio.value + bio.unit + '</div></div>';
            html += '</div>';
            
            html += '<div class="flex justify-between text-xs text-gray-500 mt-2">';
            html += '<span>' + min.toFixed(1) + bio.unit + '</span>';
            html += '<span>' + max.toFixed(1) + bio.unit + '</span></div>';
            
            html += '<div class="mt-4 text-sm text-gray-700">';
            html += '<p><strong>Normal range:</strong> ' + bio.normalMin + bio.unit + ' to ' + bio.normalMax + bio.unit + '</p>';
            if (bio.targetValue) {
                html += '<p><strong>Target:</strong> Below ' + bio.targetValue + bio.unit + '</p>';
            }
            if (bio.thresholdValue) {
                html += '<p><strong>Action threshold:</strong> ' + bio.thresholdValue + bio.unit + '</p>';
            }
            html += '</div></div>';
            
            html += '<div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4">';
            html += '<h4 class="font-semibold text-blue-900 mb-2">Interpretation</h4>';
            html += '<p class="text-blue-800">Your ' + bio.biomarkerName + ' is <strong>' + bio.value + bio.unit + '</strong>.';
            if (bio.value < bio.normalMin) {
                html += ' This is below the normal range.';
            } else if (bio.value > bio.normalMax) {
                html += ' This is above the normal range.';
            } else {
                html += ' This is within the normal range.';
            }
            html += '</p>';
            if (bio.targetValue) {
                html += '<p class="text-blue-800 mt-2">';
                if (bio.value <= bio.targetValue) {
                    html += 'You have reached the target of ' + bio.targetValue + bio.unit + '.';
                } else {
                    html += 'The target for you is ' + bio.targetValue + bio.unit + '.';
                }
                html += '</p>';
            }
            html += '</div></div>';
            
            return html;
        }

        function renderLikelihood() {
            var results = calculateLikelihood();
            var html = '';
            html += '<h2 class="text-2xl font-bold text-gray-900 mb-4">Pre/Post-Test Probability Calculator</h2>';
            html += '<p class="text-gray-600 mb-6">Apply Bayesian reasoning using a Fagan\'s Nomogram. Adjust your pre-test probability (your "gestalt") with the likelihood ratio of a test to determine the post-test probability.</p>';

            html += '<div class="grid md:grid-cols-2 gap-6 mb-8">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Pre-Test Probability (%)</label>';
            html += '<input type="number" value="' + state.likelihood.preTestProb + '" onchange="updateState(\'likelihood\', \'preTestProb\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0.1" max="99.9" step="1"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Likelihood Ratio (LR)</label>';
            html += '<input type="number" value="' + state.likelihood.likelihoodRatio + '" onchange="updateState(\'likelihood\', \'likelihoodRatio\', parseFloat(this.value))" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="0" step="0.1"></div>';
            html += '</div>';

            if(results.postTestProb !== null) {
                html += '<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8">';
                html += '<p class="text-blue-800">With a pre-test probability of <strong>' + state.likelihood.preTestProb + '%</strong> and a likelihood ratio of <strong>' + state.likelihood.likelihoodRatio + '</strong>, the post-test probability is approximately <strong>' + results.postTestProb.toFixed(1) + '%</strong>.</p></div>';
            } else {
                html += '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-8">';
                html += '<p class="text-yellow-800">Please enter a valid pre-test probability (0.1-99.9) and a positive likelihood ratio.</p></div>';
            }
            
            html += '<div><h3 class="text-lg font-semibold text-gray-900 mb-4">Fagan\'s Nomogram</h3>';
            html += createFaganNomogram(state.likelihood.preTestProb, state.likelihood.likelihoodRatio, results.postTestProb);
            html += '</div>';

            return html;
        }


        function updateState(tab, key, value) {
            state[tab][key] = value;
            render();
        }

        function switchTab(tabName) {
            state.activeTab = tabName;
            
            var buttons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].dataset.tab === tabName) {
                    buttons[i].className = 'tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors bg-blue-900 text-white';
                } else {
                    buttons[i].className = 'tab-btn px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors bg-white text-gray-700 hover:bg-gray-100';
                }
            }
            
            render();
        }

        function render() {
            var content = document.getElementById('tab-content');
            var html = '';
            
            switch(state.activeTab) {
                case 'diagnostic':
                    html = renderDiagnostic();
                    break;
                case 'risk':
                    html = renderRisk();
                    break;
                case 'reduction':
                    html = renderReduction();
                    break;
                case 'nnt':
                    html = renderNNT();
                    break;
                case 'relative':
                    html = renderRelative();
                    break;
                case 'biomarker':
                    html = renderBiomarker();
                    break;
                case 'likelihood':
                    html = renderLikelihood();
                    break;
            }
            
            content.innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', function() {
            switchTab('diagnostic');
        });
    </script>
</body>
</html>
